@model List<DOAN_Web.Models.Product>
@{
    ViewData["Title"] = ViewBag.Category.Name;
    var category = (DOAN_Web.Models.Category)ViewBag.Category;
}

<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="#" id="categoryBreadcrumb">Danh mục</a></li>
            <li class="breadcrumb-item active">@category.Name</li>
        </ol>
    </nav>
    
    <h2 class="mb-2 text-dark">@category.Name</h2>
    <p class="text-secondary mb-4">@category.Description</p>
    
    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-box-seam display-1 text-secondary"></i>
            <h4 class="mt-3 text-dark">Chưa có sản phẩm trong danh mục này</h4>
            <a asp-controller="Home" asp-action="Index" class="btn btn-primary mt-3">Về trang chủ</a>
        </div>
    }
    else
    {
        <div class="row g-4 product-grid">
            @foreach (var product in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 product-item">
                    <div class="card h-100 shadow-sm border-0 product-card">
                        <a href="/sach/@product.Slug">
                            <img src="@product.CoverImageUrl" class="card-img-top" alt="@product.Title" 
                                 style="height: 300px; object-fit: cover;">
                        </a>
                        <div class="card-body">
                            <h6 class="card-title text-truncate">
                                <a href="/sach/@product.Slug" class="text-decoration-none text-dark fw-semibold">@product.Title</a>
                            </h6>
                            <p class="text-secondary small mb-2">@product.Author.Name</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-danger fw-bold">@product.Price.ToString("N0") ₫</span>
                                @if (product.StockQty > 0)
                                {
                                    <button class="btn btn-sm btn-outline-primary add-to-cart-btn" 
                                            data-product-id="@product.ProductId" 
                                            data-product-title="@product.Title">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Hết hàng</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        @if (ViewBag.TotalPages > 1)
        {
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-action="Category" asp-route-slug="@category.Slug" asp-route-page="@i">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Category breadcrumb click - opens dropdown
            $('#categoryBreadcrumb').click(function(e) {
                e.preventDefault();
                $('#categoryDropdownTrigger').trigger('click');
            });
            
            gsap.from(".product-item", {
                opacity: 0,
                y: 50,
                stagger: 0.1,
                duration: 0.6,
                ease: "power2.out"
            });
            
            $('.add-to-cart-btn').click(function() {
                var button = $(this);
                var productId = button.data('product-id');
                var productTitle = button.data('product-title');
                
                $.ajax({
                    url: '/cart/them',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        productId: productId,
                        quantity: 1
                    }),
                    success: function(response) {
                        if (response.success) {
                            updateCartCount();
                            showToast('Đã thêm "' + productTitle + '" vào giỏ hàng', 'success');
                            anime({
                                targets: button[0],
                                scale: [1, 1.2, 1],
                                duration: 500
                            });
                        } else {
                            showToast(response.message || 'Có lỗi xảy ra', 'error');
                        }
                    },
                    error: function() {
                        window.location.href = '/Account/DangNhap';
                    }
                });
            });
        });
    </script>
}
